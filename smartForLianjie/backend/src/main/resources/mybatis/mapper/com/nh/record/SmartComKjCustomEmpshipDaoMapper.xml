<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nh.smart.dao.record.SmartKjCustomEmpshipDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.nh.smart.entity.record.SmartKjCustomEmpship">
        <id column="comid" property="comid"/>
        <result column="empno" property="empno"/>
        <result column="userid" property="userid"/>
        <result column="tsflag" property="tsflag"/>
        <result column="flushtime" property="flushtime"/>
        <result column="abdflag" property="abdflag"/>
        <result column="nbsflag" property="nbsflag"/>
        <result column="intime" property="intime"/>
        <result column="fromsctype" property="fromsctype"/>
        <result column="fromsno" property="fromsno"/>
        <result column="zkhflag" property="zkhflag"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="sql_columns">
            comid, empno, userid, tsflag, flushtime, abdflag, nbsflag, intime, fromsctype, fromsno, zkhflag
    </sql>

    <!-- 张宁 添加客户与业务员关系-->
    <insert id="insertCustomEmpship">
        insert into smart_com_kj_custom_empship(empno, userid, tsflag, flushtime, abdflag, nbsflag, intime,
        fromsctype, fromsno, zkhflag, comid)
        values(
        <if test="smartKjCustomEmpship.empno != null and smartKjCustomEmpship.empno != ''">
            #{smartKjCustomEmpship.empno},
        </if>
        <if test='smartKjCustomEmpship.empno == null or smartKjCustomEmpship.empno == ""'>
            null,
        </if>
        <if test="smartKjCustomEmpship.userid != null and smartKjCustomEmpship.userid != ''">
            #{smartKjCustomEmpship.userid},
        </if>
        <if test='smartKjCustomEmpship.userid == null or smartKjCustomEmpship.userid == ""'>
            null,
        </if>
        <if test="smartKjCustomEmpship.tsflag != null and smartKjCustomEmpship.tsflag != ''">
            #{smartKjCustomEmpship.tsflag},
        </if>
        <if test='smartKjCustomEmpship.tsflag == null or smartKjCustomEmpship.tsflag == ""'>
            null,
        </if>
        <if test="smartKjCustomEmpship.flushtime != null">
            #{smartKjCustomEmpship.flushtime},
        </if>
        <if test='smartKjCustomEmpship.flushtime == null'>
            null,
        </if>
        <if test="smartKjCustomEmpship.abdflag != null and smartKjCustomEmpship.abdflag != ''">
            #{smartKjCustomEmpship.abdflag},
        </if>
        <if test='smartKjCustomEmpship.abdflag == null or smartKjCustomEmpship.abdflag == ""'>
            null,
        </if>
        <if test="smartKjCustomEmpship.nbsflag != null and smartKjCustomEmpship.nbsflag != ''">
            #{smartKjCustomEmpship.nbsflag},
        </if>
        <if test='smartKjCustomEmpship.nbsflag == null or smartKjCustomEmpship.nbsflag == ""'>
            null,
        </if>
        <if test="smartKjCustomEmpship.intime != null">
            #{smartKjCustomEmpship.intime},
        </if>
        <if test="smartKjCustomEmpship.intime == null">
            null,
        </if>
        <if test="smartKjCustomEmpship.fromsctype != null and smartKjCustomEmpship.fromsctype != ''">
            #{smartKjCustomEmpship.fromsctype},
        </if>
        <if test='smartKjCustomEmpship.fromsctype == null or smartKjCustomEmpship.fromsctype == ""'>
            null,
        </if>
        <if test="smartKjCustomEmpship.fromsno != null and smartKjCustomEmpship.fromsno != ''">
            #{smartKjCustomEmpship.fromsno},
        </if>
        <if test='smartKjCustomEmpship.fromsno == null or smartKjCustomEmpship.fromsno == ""'>
            null,
        </if>
        <if test="smartKjCustomEmpship.zkhflag != null and smartKjCustomEmpship.zkhflag != ''">
            #{smartKjCustomEmpship.zkhflag},
        </if>
        <if test='smartKjCustomEmpship.zkhflag == null or smartKjCustomEmpship.zkhflag == ""'>
            null,
        </if>
        #{smartKjCustomEmpship.comid}
        )
        on duplicate key update flushtime = now()
        <if test='smartKjCustomEmpship.tsflag == "1"'>
            , tsflag = #{smartKjCustomEmpship.tsflag}
        </if>
    </insert>

    <!-- 张宁 查看业务员拓客数-->
    <select id="selectCustomEmpship" resultType="int">
        select count(*) from smart_com_kj_custom_empship
        where
        comid = #{comid} and empno = #{empno} and to_days(intime) = to_days(now())
    </select>

    <select id="selectCustomPage" resultType="java.util.Map">
        SELECT
            rel.userid AS userid,
            IFNULL(NULLIF(base.name, ''), IFNULL(mu.nickname, '')) AS khname,
            IFNULL(mu.headimg, '') AS headimg,
            IFNULL(NULLIF(base.mobile, ''), IFNULL(mu.mobile, '')) AS phone,
            DATE_FORMAT(rel.intime, '%Y-%m-%d %H:%i') AS intime,
            DATE_FORMAT(rel.flushtime, '%Y-%m-%d %H:%i') AS flushtime,
            IFNULL(emp.empname, '') AS ywname
        FROM smart_com_kj_custom_empship rel
        LEFT JOIN smart_com_kj_custom_basemsg base
            ON base.comid = rel.comid AND base.empno = rel.empno AND base.userid = rel.userid
        LEFT JOIN smart_com_muser mu
            ON mu.comid = rel.comid AND mu.userid = rel.userid AND mu.status = '0'
        LEFT JOIN smart_com_empno emp
            ON emp.comid = rel.comid AND emp.empno = rel.empno
        <where>
            rel.comid = #{comid}
            AND rel.empno = #{empno}
            <if test="name != null and name != ''">
                AND (base.name LIKE CONCAT('%', #{name}, '%') OR mu.nickname LIKE CONCAT('%', #{name}, '%'))
            </if>
            <if test="mode == 'address'">
                AND IFNULL(rel.tsflag, '0') != '1'
            </if>
            <if test="mode == 'recent'">
                AND IFNULL(rel.tsflag, '0') != '1'
            </if>
            <if test="mode == 'prospect'">
                AND rel.zkhflag = '1'
            </if>
            <if test="mode == 'colleague'">
                AND rel.tsflag = '1'
            </if>
            <if test="labids != null and labids.size() > 0">
                AND EXISTS (
                    SELECT 1 FROM smart_com_kj_empno_label lbl
                    WHERE lbl.comid = rel.comid
                      AND lbl.empno = rel.empno
                      AND lbl.userid = rel.userid
                      AND lbl.labid IN
                      <foreach collection="labids" item="labid" open="(" separator="," close=")">
                          #{labid}
                      </foreach>
                )
            </if>
        </where>
        ORDER BY
            <choose>
                <when test="mode == 'recent'">rel.flushtime DESC</when>
                <otherwise>rel.intime DESC</otherwise>
            </choose>
    </select>

</mapper>
