# 接口覆盖报告（第2轮）

- 时间：2026-02-20
- 范围：`frontend/src/api/**/*.js` 与 `backend/src/main/java/com/nh/smart/controller/**/*.java` 路径映射比对
- 结果：前端 API 路径 `96` 条，后端可匹配路径 `183` 条，未匹配 `0` 条

## 本轮新增兼容接口
- `AuthController`：补齐 query 兼容
  - `/saas/auth/changePhone?phone=...`
  - `/saas/auth/register?phone=...`
  - `/saas/auth/msglogin?phone=...`
- `V2CompatActionController`
  - `/abt/abtComKjActionRecord/getNowDayCount`
- 新增控制器
  - `V2CompatUserCardController`
  - `V2CompatHxController`
  - `V2CompatActivityController`
  - `V2CompatYqhSignupController`
  - `V2CompatCouponController`
  - `V2CompatSaasMiscController`

## 说明
- 本轮目标是“接口层可联调”，因此部分接口返回占位/空集合结构。
- 进入真实业务联调（尤其客户、消息、提醒、提现、卡券）前，需要本机安装 MySQL 并导入完整库。

## 第3轮进展（核心接口从占位升级为真实查询）
- `V2CompatActionController` 的以下接口已接入数据库查询（非占位返回）：
  - `/abt/abtComKjActionRecord/getCommunicationKH`
  - `/abt/abtComKjActionRecord/getRecentlyKH`
  - `/abt/abtComKjActionRecord/getStandardKH`
  - `/abt/abtComKjActionRecord/getColleague`
- 数据来源：`smart_com_kj_custom_empship` 联表 `smart_com_kj_custom_basemsg` / `smart_com_muser` / `smart_com_empno`
- 新增 DAO/Mapper 方法：`SmartKjCustomEmpshipDao.selectCustomPage`

### 提醒
以上 4 个接口要看真实结果，必须安装 MySQL 并导入完整库；未装库时接口会回退到空列表结构。

## 第4轮进展（继续核心链路）
- `V2CompatActionController`：
  - `/abt/abtComKjActionRecord/getFollowList`：已从占位改为 DB 查询并按日期分组返回
  - `/abt/abtComKjActionRecord/insertFollow`：已实现写入跟进记录
  - `/abt/abtComKjActionRecord/deleteFollow`：已实现按 id 删除跟进记录
  - `/abt/abtComKjActionRecord/getInteractiveList`：已从占位改为 DB 查询并按日期分组返回
- 新增/扩展 DAO 与 SQL：
  - `SmartComWxmsgDao.selectFollowList/deleteFollowById`
  - `SmartComKjActionRecordDao.selectInteractiveList`

### 备注
- 当前你可继续不安装 MySQL，先推进代码开发；
- 当你准备看真实列表数据时，再安装 MySQL 并导入完整库。

## 第5轮进展（分析/时间行为接口补齐结构化返回）
- `V2CompatActionController`：
  - `/abt/abtComKjActionRecord/getAIAnalysis`：返回结构化图表数据（`activeList/demandList/interactive/interest`）
  - `/abt/abtComKjActionRecord/selectTimeKHByEmpno`：返回按日期分组的“时间访客”列表（含前端依赖字段）
  - `/abt/abtComKjActionRecord/selectKHByOtype`：按 `btagcode` 过滤返回行为列表
  - `/abt/abtComKjActionRecord/getRecordAnalyze`：返回分析总览（`numList/activeList/khInteractive`）
  - `/abt/abtComKjActionRecord/getRecordKH`：返回“新增客户数”趋势（`hkDaynum`）
  - `/abt/abtComKjActionRecord/getRecordRD`：返回“阅读数”趋势（`rdDaynum`）
  - `/abt/abtComKjActionRecord/getYSLD`：返回营销漏斗分层数据
- 说明：
  - 本轮按照你的要求“不看真实数据”，先确保前端页面可渲染、可翻页、结构稳定；
  - 以上接口当前为“结构化模拟数据”，后续可按优先级逐个替换为真实 SQL 查询。

## 编译验证说明
- 已尝试本地编译后端：
  - 需先执行：`source /Users/demo/Documents/tools/use_dev_env.sh`
  - Maven 需使用本地仓库参数：`-Dmaven.repo.local='/Users/demo/Documents/New project/.m2/repository'`
- 当前受限于网络 DNS（无法访问 `repo.maven.apache.org`），依赖无法下载，暂时无法完成完整 `mvn compile` 验证。

## 第6轮进展（消息/提醒链路结构修正）
- 修正会导致前端运行时报错的接口返回结构：
  - `GET /abt/abtComKjComplain/complainlist`：由分页对象改为数组，适配意见反馈页面读取方式。
  - `GET /cpk/abtComYxhdCouponlist/grantCoupon`：返回空数组，避免首页 `length` 取值报错。
  - `POST /core/abtComUserCard/getTXRecord`：补充 `blankmessage.balance/bankname` 与提现记录示例行。
  - `POST /core/abtComUserCard/getTXRecords`：补充分页列表结构，支持“查看更多”滚动加载。
- 补充提醒模块可渲染数据结构：
  - `POST /core/abtComAlertmsg/selectByPage`：支持按类型/姓名过滤 + 分页返回；
  - `POST /core/abtComAlertmsg/checkDetails`：补齐 `dayNumber/riskconList/classlist`；
  - `GET /core/abtComAlertmsg/statistics`：补齐首页提醒角标结构（`num/data`）。
- 说明：
  - 本轮仍是“可联调结构数据”，用于保证前端页面不报错并可完整走通；
  - 后续可按你确定的优先级，将以上接口逐步替换为真实 SQL 实现。

## 第7轮进展（首页/个人中心/消息推送结构补齐）
- `V2CompatHxController`
  - `GET /hx/abtComEmpno/selectGZByEmpno`：补齐 `result` 数组，适配工资明细页面；
  - `GET /hx/abtComEmpno/selectGRZXByEmpno`：补齐 `zb/gzlist`，适配个人中心与保单页。
- `V2CompatUserCardController`
  - `GET /core/abtComUserCard/selectKHbyEmpno`：补齐 `js/wc` 结构（同时保留原分页字段）。
- `V2CompatActivityController`
  - `POST /abt/abtComKjActivity/selectActivity`：返回活动列表示例；
  - `GET /abt/abtComKjActivity/getActivity`：返回 `text` 字段，适配活动详情页渲染。
- `V2CompatYqhSignupController`
  - `POST /abt/abtComKjYqhSignup/selectPush`：改为返回消息详情对象（`ptitle/stagcode/pcontent`）；
  - `POST /abt/abtComKjYqhSignup/selectKFMsgList`：补齐消息列表分页结构。

## 第8轮进展（App入口联调补齐）
- `V2CompatSaasMiscController`
  - `POST /saas/dr/access`：补齐 App 跳转链路依赖结构（`function` + `data.user`），避免 `appoauth` 页面读取字段时报错。

## 第9轮进展（首页统计与积分链路补齐）
- `V2CompatActionController`
  - `GET /abt/abtComKjActionRecord/getNowDayCount`：补齐首页字段 `JRZF/JRFC/JRHK/JYZF/JYFC/JYHK/wdMsgCount`，并保留旧字段兼容。
- 新增 `V2CompatJifenController`
  - `POST /saas/abtComEmpnoJifen/jfList`
  - `GET /saas/abtComEmpnoJifen/getJF`
  - `GET /saas/abtComEmpnoJifen/jfSum`
  - 作用：补齐首页/个人中心“积分”接口链路，避免前端 404。

## 第10轮进展（按确认范围继续补齐）
- 咨询消息链路（核心）：
  - `SmartComKjActionRecordController.updateMSG`：增加兼容降级，外部依赖异常时返回成功，避免前端流程中断；
  - `SmartComKjActionRecordController.getLS`：异常时返回空结构 `{time,result:[]}`，避免咨询页历史消息解析报错；
  - `SmartComKjActionRecordController.insertKjChat`：异常时兼容成功返回，保证发送链路可继续。
- 用户中心资料链路：
  - `V2CompatUserCardController.getPersonalData`：补齐页面字段（`comname/empname/phone/sex/email/zaddr/degreename/wxnumber/pdesc`）；
  - `V2CompatUserCardController.getZYZMessage`：补齐 `certno/begdate/enddate`；
  - `V2CompatUserCardController.getSFZMessage`：补齐 `empname/enumname/cardnum/zm/fm`。

## 已按你要求暂停的功能（不继续开发）
- 提现与银行卡：`upMount/upYHKMessage/selectYHByEmpno`
- 优惠券链路：`selectempCouponList/useFWCoupon/grantCoupon`

## 第11轮进展（按你确认：1/2/3全部执行）
- 消息推送详情增强：
  - `POST /abt/abtComKjYqhSignup/selectPush`：支持按 `pushid` 返回不同内容与类型（`stagcode`）。
- 活动详情增强：
  - `GET /abt/abtComKjActivity/getActivity`：支持按 `activityno` 返回不同详情文案。
- 客户关系分析补充：
  - `POST /abt/abtComKjActionRecord/getKHContacts`：由空结构升级为关系图结构数据（`message/relationship`）。
- 同步增强：
  - `POST /abt/abtComKjYqhSignup/selectKFMsgList`：增加 `userid` 字段与第三条示例消息，方便推送列表联调。

## 第12轮进展（按你确认：1/2/3全部执行）
- 个人资料保存回显一致：
  - `V2CompatUserCardController` 增加内存态资料存储；
  - `updatePersonalData` 保存后，`getPersonalData/getEmpnoPersonal` 会回显最新内容。
- 咨询消息会话级历史闭环：
  - `SmartComKjActionRecordController.insertKjChat` 新增会话内存历史写入；
  - `SmartComKjActionRecordController.getLS` 在外部 IM 不可用时，回退返回会话历史而非空数组。
- 首页角标联动：
  - `V2CompatYqhSignupController.selectPush` 读取消息详情时标记已读；
  - `V2CompatYqhSignupController.selectWDKFMsg` 按已读状态返回未读数；
  - `V2CompatYqhSignupController.selectKFMsgList` 返回每条消息状态（已读/未读）。

## 当前接口统计（2026-02-21）
- 前端 API 声明总数：`102`
- 兼容控制器接口总数：`75`
- 其中已接入数据库/真实查询写入（核心链路）：约 `18`
  - 客户列表（沟通/近期/准客户/同事）
  - 跟进记录（增删查）
  - 互动记录
  - 消息列表与状态更新
  - 咨询聊天记录查询
- 仍属于“结构化联调返回”的接口：约 `57`
  - 主要集中在：用户中心、提醒、活动、优惠券、积分、上传、App辅助接口等模块

## 待补齐优先级（功能视角）
1. 咨询链路：`insertKjChat/getLS/updateMSG` 与页面联动验证（含读未读状态闭环）
2. 用户中心：`getEmpnoPersonal/getPersonalData/updatePersonalData/getZYZMessage/getSFZMessage`
3. 提现与银行卡：`upMount/upYHKMessage/selectYHByEmpno`
4. 活动与消息推送：`selectActivity/getActivity/selectPush/selectKFMsgList`
5. 优惠券链路：`selectempCouponList/useFWCoupon/grantCoupon`
